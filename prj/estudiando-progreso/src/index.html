<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa</title>

    <!-- Leaflet 1.9.3 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

    <!-- Bootstrap 5.3.0 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

</head>
<body style="padding: 0; margin: 0; height: 100vh; width: 100vw;" id="body">
    <!-- Div donde se almacena el mapa -->
    <div id="map" style="height: 100%;"></div>

    <!-- Panel de atributos -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvas-titulo">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title" id="offcanvas-titulo">Title</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close" onclick="cerrarPanel()"></button>
        </div>
        <div class="offcanvas-body" id="offcanvas-contenido">
        </div>
    </div>
  
    <!-- Modal para hacer reportes -->
    <div class="modal fade" id="reporte" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">¿Desea reportar este lugar?</h1>
            <button id="cerrar-reporte" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="cerrarModal()"></button>
            </div>
            <div class="modal-body">
                ¡Gracias por tomar la decisión de reportar! Si estas seguro de la posición presiona el botón Reportar, de lo contrario puedes verificar la posición en Google Street View.
            </div>
            <div class="modal-footer">
                <a class="btn btn-primary" id="boton-reporte" role="button">¡Reportar!</a>
                <a class="btn btn-secondary" id="boton-street" role="button">Ver en Google</a>
            </div>
        </div>
        </div>
    </div>

    <!-- Importe de capas en GeoJson -->
    <!--    Puntos de acumulacion de residuos -->
    <script src="/geoJson/reportes.js"></script>

    <!--    Puntos de recogida -->

    <!--    Rutas del camión -->

    <!--    Barrios -->
    <script src="/geoJson/barrios.js"></script>

    <script>
        // Clases
        //  Icono de marcadores: Marcadores cuando se seleciona una posición para reportar
        var markerIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon-2x.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41]
        });

        // Funciones
        //  Constructor de rutas Google Maps: Construye la ruta para llegar al punto indicado con Google Maps
        function constructorRutasGoogle(latitud, longitud) {
            rutaGoogle = "https://www.google.com/maps/dir/" + latitud + "," + longitud + "/@" + latitud + "," + longitud + ",19z";
            return rutaGoogle
        };

        //  Constructor de rutas Google Street Maps: Construye la ruta que dirige al punto en Google Street Maps
        function constructorRutasStreet(latitud, longitud) {
            rutaStreet = "http://maps.google.com/maps?q=&layer=c&cbll=" + latitud + "," + longitud;
            return rutaStreet
        };

        //  Abrir panel: Abre el panel de atributos al presionar sobre una feature
        function abrirPanel() {
            var body = document.getElementById("body");
            body.setAttribute("data-bs-padding-right", "0px");

            var offcanvas = document.getElementById("offcanvasExample");
            offcanvas.classList.add('show');
            offcanvas.setAttribute("aria-modal", "true");
            offcanvas.setAttribute("role", "dialog");

            var divFade = document.createElement("div");
            divFade.classList.add("offcanvas-backdrop", "fade", "show");
            divFade.setAttribute("id", "borrar");
            divFade.setAttribute("onclick", "cerrarPanel()");
            body.appendChild(divFade);
        };

        //  Mostrar atributos: Funciones para mostrar los atributos segun la capa de informacion
        //      Atributos de reportes: Muestra los atributos de los reportes anteriores hechos por otros usuarios

        //      Atributos de puntos de recogida: Muestra los atributos de las zonas donde se pueden depositar residups
        function atributosReportes(feature) {
            var titulo = document.getElementById("offcanvas-titulo")
            titulo.innerHTML = "Identificación del reporte: " + feature.properties.id;

            var contenido = document.getElementById("offcanvas-contenido");
            rutaImagen = "./img/";
            rutaGoogle = constructorRutasGoogle(feature.properties.latitud, feature.properties.longitud);
            contenido.innerHTML = "<img id='imagen' src=" + "'" + rutaImagen + feature.properties.id + ".webp'" + " class='rounded img-fluid'" + " alt='Imagen del reporte número "+ feature.properties.id + "'>" + 
                "<p class='lead'><strong>Dirección: </strong>" + feature.properties.direccion + "</p>" +
                "<p class='lead'><strong>Clase: </strong>" + feature.properties.clase + "</p>" +
                "<p class='lead'><strong>Contiene: </strong>" + feature.properties.contiene + "</p>" +
                "<a class='btn btn-primary' target='_blanck' href='" + rutaGoogle + "'role='button'>¿Cómo llegar?</a>";
        };

        //      Atrobutos rutas: Muestra los atributos de las rutas de los camión de basura

        //      Atributos de barrios: Muestra los atributos de los barrios en el panel
        function atributosBarrios(feature) {
            var titulo = document.getElementById("offcanvas-titulo")
            titulo.innerHTML = "Nombre del barrio: " + feature.properties.barrio;

            var contenido = document.getElementById("offcanvas-contenido");
            contenido.innerHTML = "<p class='lead'> Identificación catastral: " + feature.properties.id_barrio + "</p>";
        };

        //  Cerrar panel: Cierra el panel de atributos
        function cerrarPanel() {
            var body = document.getElementById("body");
            body.removeAttribute("data-bs-padding-right")

            var offcanva = document.getElementById("offcanvasExample");
            offcanva.classList.remove('show')
            offcanva.removeAttribute("aria-modal", "true")
            offcanva.removeAttribute("role", "dialog")

            document.getElementById("borrar").remove();
        };

        //  Abrir modal: Abre la ventana con información adicional sobre el punto que se desea reportar
        function abrirModal(latitud, longitud) {
            var body = document.getElementById("body");
            body.setAttribute("class", "modal-open");
            body.setAttribute("data-bs-padding-right", "0px");

            var modal = document.getElementById("reporte");
            modal.removeAttribute("aria-hidden", "true");
            modal.classList.add('show');
            modal.setAttribute("aria-modal", "true");
            modal.setAttribute("role", "dialog");
            modal.setAttribute("style", "display: block;");

            var botonStreet = document.getElementById("boton-street");
            botonStreet.setAttribute("href", constructorRutasStreet(latitud, longitud));
            botonStreet.setAttribute("target", "_blanck");

            var divFade = document.createElement("div");
            divFade.classList.add("offcanvas-backdrop", "fade", "show");
            divFade.setAttribute("id", "borrar");
            body.appendChild(divFade);
        };

        //  Cerrar modal: Cierra la ventana de reportes y elimina el marcador creado
        function cerrarModal(reportePunto) {
            var body = document.getElementById("body");
            body.removeAttribute("class", "modal-open");
            body.removeAttribute("data-bs-padding-right", "0px");

            var modal = document.getElementById("reporte");
            modal.setAttribute("aria-hidden", "true");
            modal.classList.remove('show');
            modal.removeAttribute("aria-modal", "true");
            modal.removeAttribute("role", "dialog");
            modal.removeAttribute("style", "display: block;");

            document.getElementById("borrar").remove();
            document.querySelectorAll(".leaflet-marker-draggable").forEach(el => el.remove());
        };

        // Inicializando clases

        const map = L.map('map');

        // Capas de informacion
        //  Mapas base
        const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });

        var esriWorldStreetMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
	        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012'
        });

        var esriWorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        //  Capas
        
        var barrios = L.geoJson(barrios_geoJson, {
            onEachFeature: function (feature, layer) {
                layer.on('click', function(ev) {
                    console.log(ev);
                    atributosBarrios(ev.target.feature);
                });
            }
        });

        var reportes = L.geoJson(reportes_geoJson, {
            onEachFeature: function (feature, layer) {
                layer.on('click', function(ev) {
                    console.log(ev);
                    atributosReportes(ev.target.feature);
                });
            }
        })

        // Grupo de capas
        var mapasBase = {
            'OpenStreetMaps': osm,
            'Esri World Street Map': esriWorldStreetMap,
            'Esri World Imagery': esriWorldImagery
        };

        var capas = {
            'Barrios': barrios,
            'Reportes': reportes
        };

        var grupoCapas = L.control.layers(mapasBase, capas, {collape: 'false'});

        // Ajustes
        osm.addTo(map);
        reportes.addTo(map);

        map.setView([3.37489,-76.54741], 16);

        barrios.on('click', abrirPanel);
        reportes.on('click', abrirPanel);

        map.on('contextmenu', function (event) {
            var reportePunto = L.marker([event.latlng.lat, event.latlng.lng], {draggable: "true", icon: markerIcon});
            reportePunto.addTo(map);
            abrirModal(event.latlng.lat, event.latlng.lng);
        });
        
        console.log(L.Icon.Default.prototype.options);
        

        grupoCapas.addTo(map);

        L.control.scale({
            metric: true
        }).addTo(map);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
</body>
</html>